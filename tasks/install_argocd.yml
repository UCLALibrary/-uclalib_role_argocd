---

- name: Create temp gitops working directory
  tempfile:
    state: directory
    suffix: gitops
  register: gitops_tmp
  notify: Remove gitops temp dir

- name: Pull GitHub Repo with env-specific values file
  git: 
    repo: "{{ argocd_values_file_repo_url }}"
    dest: "{{ gitops_tmp.path }}"
    version: "main"

- name: Create ArgoCD Kubernetes Namespace 
  command: > 
    kubectl create ns argocd 
  environment:
    KUBECONFIG: "{{ k3s_kubeconfig_path }}"

- name: Create the ExternalSecret manifest file holding Sectigo ACME credentials 
  template: 
    src: "es-sectigo-acme-creds.j2"
    dest: "{{ gitops_tmp.path }}/es-sectigo-acme-creds.j2"

- name: Create the ExternalSecret resource for Sectigo ACME credentials 
  command: > 
    kubectl apply -f {{ gitops_tmp.path }}/es-sectigo-acme-creds.j2
  environment:
    KUBECONFIG: "{{ k3s_kubeconfig_path }}"

- name: Install ArgoCD using env-specific values file
  command:
    cmd: >
      helm upgrade --install 
        argocd argo/argo-cd
        --namespace argocd 
        -f {{ gitops_tmp.path }}/{{ argocd_env_values_path }}
        --create-namespace
        --version {{ argocd_version }}
  environment:
    KUBECONFIG: "{{ k3s_kubeconfig_path }}"
  register: manifest
  changed_when:
    - '"cannot re-use a name that is still in use" not in manifest.stderr'
  failed_when:
    - manifest.rc != 0
    - '"cannot re-use a name that is still in use" not in manifest.stderr'
